name: C++ CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:  
  build_and_test:
    runs-on: ubuntu-latest
    
    steps:    
      - name: Checkout code      
        uses: actions/checkout@v2
   
      - name: Set up build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y g++ make cmake python3
          
      - name: Build project
        run: |
          make clean
          make
          
      - name: Run functional tests
        run: |
          chmod +x test_ascii85.sh
          ./test_ascii85.sh
          
      - name: Install Python for tests
        run: |
          python3 -c "import base64; print('Python base64 module available')"
          
      - name: Verify test coverage
        run: |
          if ! ./test_ascii85.sh | grep -q "All tests passed successfully!"; then
            echo "::error::Some tests failed"
            exit 1
          fi
          echo "All tests passed successfully"
